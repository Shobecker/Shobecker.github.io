<script>
  // Elements
  const digitalClock = document.getElementById("clock");
  const intervalDisplay = document.getElementById("interval");
  const intervalInput = document.getElementById("intervalInput");
  const canvas = document.getElementById("analogClock");
  const ctx = canvas.getContext("2d");
  const radius = canvas.height / 2;
  ctx.translate(radius, radius);
  const clockRadius = radius * 0.90;

  const volumeSlider = document.getElementById("volumeSlider");
  const muteToggle = document.getElementById("muteToggle");
  const toggleTimerBtn = document.getElementById("toggleTimer");
  const testBeepBtn = document.getElementById("testBeep");
  const toneSelect = document.getElementById("toneSelect");
  const resetBtn = document.getElementById("resetTimer");

  // Timer state
  let intervalDuration = parseInt(intervalInput.value) * 60;
  let intervalRemaining = intervalDuration;
  let isRunning = false; // start stopped

  // Audio
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let volume = 0.5;
  let muted = false;
  let beepTone = "sine";

  // Resume audio on first interaction
  document.body.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }, { once: true });

  volumeSlider.addEventListener("input", () => {
    volume = parseFloat(volumeSlider.value);
  });

  muteToggle.addEventListener("change", () => {
    muted = muteToggle.checked;
  });

  toneSelect.addEventListener("change", () => {
    beepTone = toneSelect.value;
  });

  function playBeep() {
    if (muted) return;
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.type = beepTone;
    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
    gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.2);
  }

  // Flash
  const flash = document.getElementById("flash");
  function triggerFlash() {
    flash.style.opacity = "1";
    setTimeout(() => {
      flash.style.opacity = "0";
    }, 100);
  }

  // Controls
  intervalInput.addEventListener("change", () => {
    const minutes = Math.max(1, parseInt(intervalInput.value) || 1);
    intervalDuration = minutes * 60;
    intervalRemaining = Math.min(intervalRemaining, intervalDuration);
    updateIntervalDisplay();
  });

  toggleTimerBtn.addEventListener("click", () => {
    isRunning = !isRunning;
    toggleTimerBtn.textContent = isRunning ? "⏸ Pause" : "▶️ Start";
  });

  testBeepBtn.addEventListener("click", () => {
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
    playBeep();
  });

  resetBtn.addEventListener("click", () => {
    intervalRemaining = intervalDuration;
    updateIntervalDisplay();
  });

  // Clock Drawing
  function drawClock() {
    drawFace(ctx, clockRadius);
    drawNumbers(ctx, clockRadius);
    drawTime(ctx, clockRadius);
  }

  function drawFace(ctx, radius) {
    ctx.beginPath();
    ctx.arc(0, 0, radius, 0, 2 * Math.PI);
    ctx.fillStyle = "#000";
    ctx.fill();

    ctx.strokeStyle = "#0f0";
    ctx.lineWidth = radius * 0.05;
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(0, 0, radius * 0.05, 0, 2 * Math.PI);
    ctx.fillStyle = "#0f0";
    ctx.fill();
  }

  function drawNumbers(ctx, radius) {
    const angOffset = Math.PI / 6;
    ctx.font = radius * 0.15 + "px arial";
    ctx.textBaseline = "middle";
    ctx.textAlign = "center";
    for (let num = 1; num <= 12; num++) {
      const ang = num * angOffset;
      ctx.rotate(ang);
      ctx.translate(0, -radius * 0.85);
      ctx.rotate(-ang);
      ctx.fillText(num.toString(), 0, 0);
      ctx.rotate(ang);
      ctx.translate(0, radius * 0.85);
      ctx.rotate(-ang);
    }
  }

  function drawTime(ctx, radius) {
    const now = new Date();
    let hour = now.getHours();
    let minute = now.getMinutes();
    let second = now.getSeconds();
    let ms = now.getMilliseconds();

    // Hours
    hour = hour % 12;
    hour = (hour * Math.PI / 6) +
           (minute * Math.PI / (6 * 60)) +
           (second * Math.PI / (360 * 60));
    drawHand(ctx, hour, radius * 0.5, radius * 0.07);

    // Minutes
    minute = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60));
    drawHand(ctx, minute, radius * 0.75, radius * 0.07);

    // Seconds (smooth with ms fraction)
    const secFraction = (second + ms / 1000) * Math.PI / 30;
    drawHand(ctx, secFraction, radius * 0.85, radius * 0.02, "#f00");
  }

  function drawHand(ctx, pos, length, width, color = "#0f0") {
    ctx.beginPath();
    ctx.lineWidth = width;
    ctx.lineCap = "round";
    ctx.strokeStyle = color;
    ctx.moveTo(0, 0);
    ctx.rotate(pos);
    ctx.lineTo(0, -length);
    ctx.stroke();
    ctx.rotate(-pos);
  }

  function updateDigitalClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    digitalClock.textContent = `${h}:${m}:${s}`;
  }

  function updateIntervalDisplay() {
    const mins = Math.floor(intervalRemaining / 60);
    const secs = intervalRemaining % 60;
    intervalDisplay.textContent =
      `Next alert in: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  }

  function updateIntervalTimer() {
    if (!isRunning) return;
    if (intervalRemaining <= 0) {
      playBeep();
      triggerFlash();
      intervalRemaining = intervalDuration;
    } else {
      intervalRemaining--;
    }
    updateIntervalDisplay();
  }

  // Animation loop
  let lastSecond = -1;
  function animate() {
    ctx.clearRect(-radius, -radius, canvas.width, canvas.height);
    drawClock();

    const now = new Date();
    const currentSecond = now.getSeconds();

    // Update digital clock + interval timer only when second changes
    if (currentSecond !== lastSecond) {
      updateDigitalClock();
      updateIntervalTimer();
      lastSecond = currentSecond;
    }

    requestAnimationFrame(animate);
  }

  // Init
  drawClock();
  updateDigitalClock();
  updateIntervalDisplay();
  animate();
</script>
